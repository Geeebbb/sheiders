import taichi as ti
import taichi.math as tm

LARGE_DIST = 1000.0


@ti.func
def smoothmin(a, b, k):
    """
    Плавный минимум двух чисел с параметром сглаживания k
    Аргументы:
        a (float): первое значение
        b (float): второе значение
        k (float): параметр сглаживания (чем больше, тем плавнее переход)

    Возвращает:
        float: плавное минимальное значение между a и b
    """
    h = max(k - abs(a - b), 0.0) / k
    return min(a, b) - h * h * k * (1.0 / 4.0)


@ti.func
def smoothmax(a, b, k):
    """
    Плавный максимум двух чисел с параметром сглаживания k
    Использует smoothmin с отрицательным k для вычисления максимума
    Аргументы:
        a (float): первое значение
        b (float): второе значение
        k (float): параметр сглаживания
    Возвращает:
        float: плавное максимальное значение между a и b
    """
    return smoothmin(a, b, -k)


@ti.func
def smoothmin3(a, b, k):
    """
    Альтернативная реализация плавного минимума с кубическим сглаживанием
    Аргументы:
        a (float): первое значение
        b (float): второе значение
        k (float): параметр сглаживания

    Возвращает:
        float: плавный минимум между a и b с кубическим сглаживанием
    """
    h = max(k - abs(a - b), 0.0) / k
    return min(a, b) - h * h * h * k * (1.0 / 6.0)


@ti.func
def skewsin(x, t):
    """
    Специальная искажённая функция синуса, основанная на arctan2

    Аргументы:
        x (float): входное значение (угол)
        t (float): параметр искажения

    Возвращает:
        float: результат искажённой функции
    """
    return ti.atan2(t * ti.sin(x), (1.0 - t * ti.cos(x))) / t


@ti.func
def hash1(n):
    """
    Одномерная хеш-функция для float
    Аргументы:
        n (float): входное значение

    Возвращает:
        float: псевдослучайное число в диапазоне [0, 1)
    """
    return tm.fract(ti.sin(n * 43758.5453))


@ti.func
def hash21(p):
    """
    Хеш-функция, преобразующая 2D вектор в одно float значение
    Аргументы:
        p (tm.vec2): входной 2D вектор

    Возвращает:
        float: псевдослучайное число в диапазоне [0, 1)
    """
    q = tm.fract(p * tm.vec2(123.34, 345.56))
    q += q @ (q + 34.23)
    return tm.fract(q.x * q.y)


@ti.func
def hash22(p):
    """
    Хеш-функция, преобразующая 2D вектор в 2D вектор псевдослучайных чисел
    Аргументы:
        p (tm.vec2): входной 2D вектор
    Возвращает:
        tm.vec2: 2D вектор с компонентами в диапазоне [0, 1)
    """
    x = hash21(p)
    y = hash21(p + x)
    return tm.vec2(x, y)


@ti.func
def rot(a):
    """
    Матрица 2D поворота на угол a (в радианах)
    Аргументы:
        a (float): угол поворота в радианах
    Возвращает:
        tm.mat2: матрица поворота 2x2
    """
    c = ti.cos(a)
    s = ti.sin(a)
    return tm.mat2([c, -s], [s, c])


@ti.func
def fract_floor(x):
    """
    Разделение числа на дробную и целую часть.
    Аргументы:
        x (float или tm.vec2): входное число или вектор
    Возвращает:
        tm.vec2: вектор, где
                 x - дробная часть,
                 y - целая часть (пол)
    """
    fl = ti.floor(x)
    return tm.vec2(x - fl, fl)


@ti.func
def length(x):
    """
    Вычисление длины (нормы) 2D вектора
    Аргументы:
        x (tm.vec2): входной вектор
    Возвращает:
        float: длина вектора
    """
    return ti.sqrt(x @ x)
